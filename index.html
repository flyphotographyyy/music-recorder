<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sequencer + ARP (Chords) + Arranger — no overdub on loop</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121926; --panel-2:#0f1623; --text:#e7eef7; --muted:#8aa0b7;
    --accent:#4cc9f0; --red:#ff3b30; --grid:#1c2535; --blue:#4db2ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(160deg,#0b0f14,#0a0d12);color:var(--text);font:14px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{display:flex;align-items:center;gap:12px;padding:14px 16px;background:rgba(255,255,255,.03);backdrop-filter: blur(6px);position:sticky;top:0;z-index:6;border-bottom:1px solid #101624}
  h1{font-size:16px;margin:0;color:var(--text);opacity:.95;font-weight:700}
  .badge{font-size:11px;padding:3px 8px;border-radius:999px;background:linear-gradient(180deg,#122338,#0e1a2b);border:1px solid #1f2a3e;color:var(--muted)}
  .btn{appearance:none;border:1px solid #1c2a40;background:linear-gradient(180deg,#152032,#0f1827);color:var(--text);padding:8px 14px;border-radius:10px;cursor:pointer;transition:transform .05s ease,box-shadow .2s}
  .btn:hover{box-shadow:0 4px 16px rgba(76,201,240,.12)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(180deg,#1f2c45,#16243b);border-color:#274260}
  .btn.danger{border-color:#4b1f27;background:linear-gradient(180deg,#3a1217,#2a0f13);color:#ffd7db}
  input, select{background:#0c1320;border:1px solid #1b2942;color:var(--text);padding:8px;border-radius:10px;outline:none}
  select{min-width:120px}
  .control{display:flex;flex-direction:column;gap:6px;min-width:120px}
  .row{display:flex;gap:10px;flex-wrap:wrap;padding:12px}
  .panel{background:var(--panel);border:1px solid #162033;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
  .panel h2{font-size:13px;margin:0;padding:10px 12px;border-bottom:1px solid #17253a;background:linear-gradient(180deg,#121b2a,#0f1827);color:var(--muted);letter-spacing:.4px;text-transform:uppercase}

  .layout{ display:grid; grid-template-columns: 1fr; gap:14px; padding:14px; }

  /* Timeline */
  .timeline{padding:12px;display:grid;gap:10px}
  .timeline-toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;padding:0 12px 4px}
  .timeline-toolbar .badge{border-radius:8px}
  .barLabels{display:flex;justify-content:space-between;font-size:11px;color:#7e91a9;padding:0 4px}
  .steps{display:grid;gap:8px;position:relative;background:var(--panel-2);padding:10px;border-radius:12px;border:1px solid #1a263b;grid-template-columns:repeat(8,1fr)}
  .step{aspect-ratio:1.6/1;border-radius:10px;border:1px solid #23324c;background:linear-gradient(180deg,#0f1827,#0b1320);display:flex;align-items:center;justify-content:center;color:#8aa0b7;cursor:pointer;user-select:none;transition:all .15s}
  .step.on{border-color:#2f8ac9;background:linear-gradient(180deg,#123152,#0e1c32);color:#d8eeff;box-shadow:inset 0 0 0 1px #2f8ac9}
  .playhead{position:absolute;top:8px;bottom:8px;width:3px;background:var(--red);border-radius:2px;box-shadow:0 0 6px rgba(255,59,48,.8);transform:translateX(-1px);pointer-events:none}

  .laneTitle{font-size:12px;color:#96a8c0;margin-top:2px}
  .lane{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center}
  .lane .name{color:#9fb3cd;font-size:12px;text-align:right;padding-right:6px}
  .lane .cells{display:grid;grid-template-columns:repeat(8,1fr);gap:8px}
  .cell{aspect-ratio:1.6/1;border-radius:8px;border:1px solid #23324c;background:linear-gradient(180deg,#0f1827,#0b1320);display:flex;align-items:center;justify-content:center;color:#8aa0b7;cursor:pointer}
  .cell.on{border-color:#2f8ac9;background:linear-gradient(180deg,#123152,#0e1c32);color:#d8eeff;box-shadow:inset 0 0 0 1px #2f8ac9}
  .noteRow{display:grid;gap:8px;grid-template-columns:120px 1fr}
  .noteRow .name{color:#9fb3cd;text-align:right;padding-right:6px}
  .noteRow .selects{display:grid;grid-template-columns:repeat(8,1fr);gap:8px}

  /* Arranger */
  .arranger{padding:12px;border-top:1px solid #17253a;background:linear-gradient(0deg,#0e1624,#0f1a2a)}
  .arr-toolbar{display:flex;gap:10px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .arr-toolbar .len{font-size:12px;color:var(--muted)}
  .arr-wrap{position:relative;border:1px solid #1a263b;border-radius:12px;background:var(--panel-2);height:220px;overflow:hidden}
  .arr-axis{position:absolute;left:0;right:0;top:0;height:18px;color:#7e91a9;font-size:10px;padding:2px 6px;display:flex;gap:12px;align-items:center}
  .arr-track{position:absolute;left:0;right:0;top:18px;bottom:0}
  .arr-event{position:absolute;height:18px;border:1px solid #2a4270;border-radius:6px;background:linear-gradient(180deg,#163055,#102137);color:#cfe6ff;font-size:10px;display:flex;align-items:center;justify-content:center;user-select:none}
  .arr-event.note{background:linear-gradient(180deg,#1a3a66,#11253d)}
  .arr-playhead{position:absolute;top:0;bottom:0;width:2px;background:var(--red);box-shadow:0 0 6px rgba(255,59,48,.8);pointer-events:none}
  .arr-limit{position:absolute;top:0;bottom:0;width:3px;background:var(--blue);box-shadow:0 0 6px rgba(77,178,255,.9);cursor:ew-resize}
  .laneLabel{position:absolute;left:6px;font-size:10px;color:#97a8c0;opacity:.9}
  .laneGrid{position:absolute;left:0;right:0;height:18px;border-bottom:1px solid #1b2a40}
  .inline-help{font-size:12px;color:#8aa0b7;padding:0 12px 10px}

  /* ARP + NR line */
  .arp-line{display:grid;grid-template-columns:80px 1fr 1fr 1fr 1fr;gap:8px;align-items:end;padding:0 12px 6px}
  .arp-line .grp{display:flex;flex-direction:column;gap:6px}
  .arp-line label{font-size:12px;color:#8aa0b7}
</style>
</head>
<body>
<header>
  <h1>Sequencer + ARP (Chords) + Arranger</h1>
  <span class="badge">End line = song end</span>
  <span class="badge">No overdub on loop</span>
</header>

<main class="layout">
  <section class="panel">
    <h2>Timeline &amp; Transport</h2>

    <div class="row">
      <button id="startBtn" class="btn primary">Start</button>
      <button id="stopBtn" class="btn danger">Stop</button>

      <div class="control">
        <label for="bpm">BPM</label>
        <input type="range" id="bpm" min="60" max="200" step="1" value="120" />
        <div><span id="bpmVal">120</span> bpm</div>
      </div>
    </div>

    <div class="timeline">
      <!-- ARP (само за Chords) + Note Repeat -->
      <div class="arp-line" id="arpLine">
        <div class="grp">
          <label><input type="checkbox" id="arpOn"> Arp On</label>
        </div>
        <div class="grp">
          <label for="arpRate">Arp Rate</label>
          <select id="arpRate">
            <option>1/4</option><option selected>1/8</option><option>1/16</option><option>1/32</option>
          </select>
        </div>
        <div class="grp">
          <label for="arpDir">Arp Dir</label>
          <select id="arpDir">
            <option selected>Up</option><option>Down</option><option>UpDown</option><option>Random</option>
          </select>
        </div>
        <div class="grp">
          <label for="arpOct">Arp Oct</label>
          <select id="arpOct">
            <option selected>×1</option><option>×2</option><option>×3</option>
          </select>
        </div>
        <div class="grp">
          <label><input type="checkbox" id="nrOn"> Note Repeat</label>
          <select id="nrRate">
            <option>1/8</option><option selected>1/16</option><option>1/32</option>
          </select>
        </div>
      </div>

      <div class="barLabels" id="barLabels"><span>1</span><span>5</span></div>

      <div class="steps" id="steps">
        <div class="playhead" id="playhead"></div>
      </div>

      <!-- Chords lane -->
      <div class="noteRow" id="chordsRow">
        <div class="name">Chords</div>
        <div class="selects" id="chordsSelects"></div>
      </div>

      <!-- Bass 303 lane (визуално) -->
      <div class="laneTitle">Bass 303</div>
      <div class="lane">
        <div class="name">Pattern</div>
        <div class="cells" id="bassCells"></div>
      </div>
      <div class="noteRow" id="bassNotesRow">
        <div class="name">Notes</div>
        <div class="selects" id="bassNotesSelects"></div>
      </div>

      <!-- WT lane (визуално) -->
      <div class="laneTitle">Wavetable</div>
      <div class="lane">
        <div class="name">Pattern</div>
        <div class="cells" id="wtCells"></div>
      </div>
      <div class="noteRow" id="wtNotesRow">
        <div class="name">Notes</div>
        <div class="selects" id="wtNotesSelects"></div>
      </div>
    </div>

    <!-- Arranger -->
    <div class="arranger">
      <div class="arr-toolbar">
        <button id="arrPlay" class="btn primary">▶ TL Play</button>
        <button id="arrStop" class="btn danger">■ TL Stop</button>
        <span class="len">Length <b id="lenLabel">00:10</b> — синята линия е краят</span>
      </div>
      <div class="arr-wrap" id="arrWrap">
        <div class="arr-axis" id="arrAxis"></div>
        <div class="arr-track" id="arrTrack"></div>
        <div class="arr-playhead" id="arrPlayhead"></div>
        <div class="arr-limit" id="arrLimit" title="Drag to set length"></div>
      </div>
      <div class="inline-help">Arranger се попълва само от твоите действия (стъпки/акорди/ARP). Няма наслагване при луп.</div>
    </div>
  </section>
</main>

<script>
/* ================== Audio ================== */
const Audio = (()=>{
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const master = ctx.createGain(); master.gain.value=0.8; master.connect(ctx.destination);
  const dryBus = ctx.createGain(); dryBus.gain.value=0.9; dryBus.connect(master);

  function playVoice({freq=220,time=ctx.currentTime,dur=0.25,vel=0.9}){
    const osc = ctx.createOscillator(); osc.type="sawtooth"; osc.frequency.setValueAtTime(freq,time);
    const filt = ctx.createBiquadFilter(); filt.type="lowpass"; filt.frequency.setValueAtTime(2000,time); filt.Q.setValueAtTime(0.6,time);
    const env = ctx.createGain(); env.gain.setValueAtTime(0.0001,time);
    env.gain.linearRampToValueAtTime(vel,time+0.005);
    env.gain.exponentialRampToValueAtTime(0.001, time+dur);
    osc.connect(filt).connect(env).connect(dryBus);
    osc.start(time); osc.stop(time+dur+0.05);
    osc.onended=()=>{try{osc.disconnect();filt.disconnect();env.disconnect();}catch{}}
  }
  return { ctx, playVoice };
})();

/* ======= Theory ======= */
const Theory = (()=>{
  const noteMap={"C":0,"C#":1,"Db":1,"D":2,"D#":3,"Eb":3,"E":4,"F":5,"F#":6,"Gb":6,"G":7,"G#":8,"Ab":8,"A":9,"A#":10,"Bb":10,"B":11};
  function midiFromName(name="C4"){ const m=/^([A-G][#b]?)(-?\d)$/.exec(name); if(!m) return 60; const n=noteMap[m[1]]??0; const oct=parseInt(m[2],10); return 12*(oct+1)+n; }
  function freq(name="C4"){ const midi=midiFromName(name); return 440*Math.pow(2,(midi-69)/12); }
  function chordToNotes(label="Am"){
    const roots=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];
    let root=roots.find(r=>label.startsWith(r))||"C"; let q=label.slice(root.length).trim();
    const baseMidi=12*(4+1)+{"C":0,"Db":1,"D":2,"Eb":3,"E":4,"F":5,"Gb":6,"G":7,"Ab":8,"A":9,"Bb":10,"B":11}[root];
    const thirds = q.includes("m") && !q.includes("maj") ? 3 : 4;
    const seventh = q.includes("maj7")? 11 : (q.includes("7")? 10 : null);
    const sus2=/sus2/.test(q), sus4=/sus4/.test(q), add9=/add9/.test(q);
    const mids=[]; if(sus2){ mids.push(baseMidi+2); } else if(sus4){ mids.push(baseMidi+5); } else { mids.push(baseMidi+thirds); }
    mids.push(baseMidi); mids.push(baseMidi+7); if(seventh!==null) mids.push(baseMidi+seventh); if(add9) mids.push(baseMidi+14);
    const freqs = mids.map(m=>440*Math.pow(2,(m-69)/12)).sort((a,b)=>a-b);
    return freqs;
  }
  const pitchChoices = (()=>{
    const octaves=[2,3,4]; const keys=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const arr=[]; for(const o of octaves){ for(const k of keys){ arr.push(k+o); } } return arr;
  })();
  return { freq, chordToNotes, pitchChoices };
})();

/* ======= UI (8 стъпки, диалози) ======= */
const UI = (()=>{
  const stepsEl = document.getElementById('steps');
  const playheadEl = document.getElementById('playhead');
  const chordsSelects = document.getElementById('chordsSelects');
  const barLabels = document.getElementById('barLabels');
  const bpmEl = document.getElementById('bpm'); const bpmVal=document.getElementById('bpmVal'); bpmEl.addEventListener('input',()=> bpmVal.textContent=bpmEl.value);

  const arpOn = document.getElementById('arpOn');
  const arpRate = document.getElementById('arpRate');
  const arpDir = document.getElementById('arpDir');
  const arpOct = document.getElementById('arpOct');
  const nrOn = document.getElementById('nrOn');
  const nrRate = document.getElementById('nrRate');

  const steps = Array.from({length:8},(_,i)=>{
    const d=document.createElement('div'); d.className='step'; d.textContent=i+1;
    d.addEventListener('click', ()=>{ d.classList.toggle('on'); Mirror.syncChordsToArranger(); });
    stepsEl.appendChild(d); return d;
  });

  const chordOptions=["C","Cm","Cmaj7","C7","C add9","C sus2","C sus4","D","Dm","Dmaj7","D7","D add9","D sus2","D sus4","E","Em","Emaj7","E7","E add9","E sus2","E sus4","F","Fm","Fmaj7","F7","F add9","F sus2","F sus4","G","Gm","Gmaj7","G7","G add9","G sus2","G sus4","A","Am","Amaj7","A7","A add9","A sus2","A sus4","B","Bm","Bmaj7","B7","B add9","B sus2","B sus4"];
  const chords = Array.from({length:8},()=> "Am");
  for(let i=0;i<8;i++){
    const s=document.createElement('select'); chordOptions.forEach(opt=>{ const o=document.createElement('option'); o.value=o.textContent=opt; s.appendChild(o); });
    s.value=chords[i];
    s.addEventListener('change', ()=>{ chords[i]=s.value; Mirror.syncChordsToArranger(); });
    chordsSelects.appendChild(s);
  }

  // Bass/WT (визуално, за да пасне на UI ти; не записват)
  const bassCells=document.getElementById('bassCells'), bassNotesSelects=document.getElementById('bassNotesSelects');
  const wtCells=document.getElementById('wtCells'), wtNotesSelects=document.getElementById('wtNotesSelects');
  const pitch=Theory.pitchChoices;
  for(let i=0;i<8;i++){
    const c1=document.createElement('div'); c1.className='cell'; c1.textContent=i+1; c1.addEventListener('click',()=> c1.classList.toggle('on')); bassCells.appendChild(c1);
    const n1=document.createElement('select'); pitch.forEach(p=>{ const o=document.createElement('option'); o.value=o.textContent=p; n1.appendChild(o); }); n1.value=["C2","E2","G2","A2","C3","E3","G2","A2"][i%8]; bassNotesSelects.appendChild(n1);

    const c2=document.createElement('div'); c2.className='cell'; c2.textContent=i+1; c2.addEventListener('click',()=> c2.classList.toggle('on')); wtCells.appendChild(c2);
    const n2=document.createElement('select'); pitch.forEach(p=>{ const o=document.createElement('option'); o.value=o.textContent=p; n2.appendChild(o); }); n2.value=["C3","D3","E3","G3","A3","B3","A3","G3"][i%8]; wtNotesSelects.appendChild(n2);
  }

  barLabels.innerHTML='<span>1</span><span>5</span>';

  // expose
  return {
    steps, chords, bpmEl, playheadEl,
    arp: { arpOn, arpRate, arpDir, arpOct, nrOn, nrRate }
  };
})();

/* ======= Transport (tick = 1/8 note) + ARP playback ======= */
const Transport = (()=>{
  const S={running:false, stepIndex:0, timer:null};
  function stepMs(){ return 60000 / parseInt(UI.bpmEl.value,10) / 2; } // 1/8
  function start(){ Audio.ctx.resume(); if(S.running) return; S.running=true; S.stepIndex=0; tick(); }
  function stop(){ if(!S.running) return; S.running=false; if(S.timer){ clearTimeout(S.timer); S.timer=null; } }
  function scheduleNext(){ if(!S.running) return; const ms=stepMs(); S.timer=setTimeout(tick, ms); }

  function parseRate(txt){ const [a,b]=txt.split('/').map(Number); return a/b; } // e.g. 1/16 -> 0.0625 (note length of a whole)
  function rateToMs(rate, bpm){ // duration of that note in ms
    const quarterMs = 60000 / bpm;
    const wholeMs = quarterMs * 4;
    return wholeMs * rate;
  }

  function buildArpOrder(freqs, dir, octMult){
    // freqs sorted asc
    const list=[];
    for(let oct=0; oct<octMult; oct++){
      const mul = Math.pow(2, oct);
      const base = freqs.map(f=> f*mul);
      if(dir==='Up') list.push(...base);
      else if(dir==='Down') list.push(...base.slice().reverse());
      else if(dir==='UpDown'){
        const up=base, down=base.slice().reverse().slice(1,-1);
        list.push(...up, ...down);
      }else if(dir==='Random'){
        const rnd=base.slice();
        for(let i=rnd.length-1;i>0;i--){ const j=(Math.random()* (i+1))|0; [rnd[i],rnd[j]]=[rnd[j],rnd[i]]; }
        list.push(...rnd);
      }
    }
    return list.length? list : freqs;
  }

  function tick(){
    if(!S.running) return;
    const ms=stepMs(); const t=Audio.ctx.currentTime; const i=S.stepIndex;
    UI.playheadEl.style.left = ((i/8)*100)+'%';

    // ----- Playback: Chords with ARP / Note Repeat -----
    if(UI.steps[i].classList.contains('on')){
      const chordLabel = UI.chords[i];
      const baseFreqs = Theory.chordToNotes(chordLabel); // asc

      const arpEnabled = UI.arp.arpOn.checked;
      const bpm = parseInt(UI.bpmEl.value,10);

      if(arpEnabled){
        const rate = UI.arp.arpRate.value;                 // e.g. 1/16
        const segMs = rateToMs(parseRate(rate), bpm);      // ms per arp note
        const stepDurMs = ms;                               // step = 1/8
        const count = Math.max(1, Math.floor(stepDurMs/segMs));
        const dir = UI.arp.arpDir.value;
        const octMult = parseInt(UI.arp.arpOct.value.replace('×',''),10) || 1;
        const order = buildArpOrder(baseFreqs, dir, octMult);

        for(let k=0;k<count;k++){
          const f = order[k % order.length];
          const when = t + (k*segMs)/1000;
          const dur = Math.max(0.05, (segMs*0.9)/1000);
          Audio.playVoice({freq:f, time:when, dur});
        }
      }else{
        // Note Repeat (на целия акорд)
        const nrEnabled = UI.arp.nrOn.checked;
        if(nrEnabled){
          const rate = UI.arp.nrRate.value;
          const segMs = rateToMs(parseRate(rate), parseInt(UI.bpmEl.value,10));
          const stepDurMs = ms;
          const count = Math.max(1, Math.floor(stepDurMs/segMs));
          for(let k=0;k<count;k++){
            const when = t + (k*segMs)/1000;
            const dur = Math.max(0.06, (segMs*0.9)/1000);
            baseFreqs.forEach(f=> Audio.playVoice({freq:f, time:when, dur}));
          }
        }else{
          // Еднократно свирене на акорда
          baseFreqs.forEach(f=> Audio.playVoice({freq:f, time:t, dur:ms/1000*0.9}));
        }
      }
    }

    S.stepIndex = (S.stepIndex+1)%8;
    scheduleNext();
  }
  return { start, stop };
})();

/* ======= Arranger (видим целият таймлайн, край = синя линия) ======= */
const Arranger = (()=>{
  const wrap=document.getElementById('arrWrap'); const axis=document.getElementById('arrAxis'); const track=document.getElementById('arrTrack');
  const playhead=document.getElementById('arrPlayhead'); const limit=document.getElementById('arrLimit'); const lenLabel=document.getElementById('lenLabel');

  let lenSec=10;           // по подразбиране 0:10
  let pxPerSec=1;          // винаги така, че да се вижда цялата дължина
  const events=[];         // единствено от Mirror.* (твои действия). НЯМА добавяне при tick/loop.

  function fmt(sec){ const m=Math.floor(sec/60), s=Math.floor(sec%60); return (m+'').padStart(2,'0')+':'+(s+'').padStart(2,'0'); }

  function layout(){
    pxPerSec = wrap.clientWidth / lenSec;         // цялата дължина се побира
    axis.innerHTML='';
    const total=Math.ceil(lenSec);
    for(let s=0;s<=total;s++){
      const x=s*pxPerSec;
      const tick=document.createElement('div'); tick.style.cssText=`position:absolute;top:0;bottom:0;left:${x}px;border-left:1px solid #1e2a3d`; axis.appendChild(tick);
      const lab=document.createElement('div'); lab.style.cssText=`position:absolute;left:${x}px;top:0;transform:translate(-50%,0);font-size:10px;color:#7e91a9`; lab.textContent=fmt(s); axis.appendChild(lab);
    }
    // limit = край на песента (синя линия)
    limit.style.left = (lenSec*pxPerSec - limit.offsetWidth/2) + 'px';

    // прерисуване на евентите
    track.innerHTML='';
    for(const ev of events){
      const el=document.createElement('div'); el.className='arr-event note'; el.textContent='ch';
      const w=Math.max(8, ev.dur*pxPerSec);
      el.style.left=(ev.t*pxPerSec)+'px'; el.style.width=w+'px'; el.style.top='26px';
      track.appendChild(el);
    }
  }

  // плейбек на таймлайн
  let playing=false, startTime=0;
  function play(){ if(playing) return; Audio.ctx.resume(); playing=true; startTime=Audio.ctx.currentTime; raf(); }
  function stop(){ playing=false; }
  function raf(){
    if(!playing) return;
    const now=Audio.ctx.currentTime;
    const local = ((now-startTime) % lenSec);
    playhead.style.left = (local*pxPerSec)+'px';
    requestAnimationFrame(raf);
  }

  // drag на синята линия
  (function dragLimit(){
    let drag=false, sx=0, sl=0;
    limit.addEventListener('mousedown', (e)=>{ drag=true; sx=e.clientX; sl=parseFloat(limit.style.left)||((lenSec*pxPerSec)); e.preventDefault(); });
    window.addEventListener('mousemove', (e)=>{
      if(!drag) return;
      const dx=e.clientX-sx; const rect=wrap.getBoundingClientRect();
      const nx=Math.max(40, Math.min(rect.width-2, sl+dx));
      limit.style.left=nx+'px';
      lenSec = nx / pxPerSec;
      lenLabel.textContent = fmt(lenSec);
      layout(); // запази „да се вижда целият таймлайн“
    });
    window.addEventListener('mouseup', ()=> drag=false);
  })();

  window.addEventListener('resize', layout);
  layout(); lenLabel.textContent = fmt(lenSec);

  // публични
  function resetEvents(){ events.length=0; layout(); }
  function setEvents(newEvents){ events.length=0; newEvents.forEach(e=> events.push(e)); layout(); }

  return { play, stop, setLen:(s)=>{ lenSec=Math.max(3, Number(s)||10); lenLabel.textContent=fmt(lenSec); layout(); }, setEvents, resetEvents, get lenSec(){return lenSec;} };
})();

/* ======= Mirror (само твоите действия -> генерира Arranger евенти) ======= */
const Mirror = (()=>{
  // Правило: НИКОГА не дописваме по време на плейбек/луп.
  // Регенерираме клиповете ЕДНОКРАТНО при действие на потребителя.

  function syncChordsToArranger(){
    const bpm = parseInt(UI.bpmEl.value,10);
    const stepDurSec = (60/bpm) / 2; // 1/8 note
    const events=[];

    const arpEnabled = UI.arp.arpOn.checked;
    const arpRate = UI.arp.arpRate.value;
    const arpDir  = UI.arp.arpDir.value;
    const arpOct  = parseInt(UI.arp.arpOct.value.replace('×',''),10) || 1;
    const nrEnabled = UI.arp.nrOn.checked;
    const nrRate = UI.arp.nrRate.value;

    function parseRate(txt){ const [a,b]=txt.split('/').map(Number); return a/b; }
    function rateToSec(rate, bpm){ const quarter=60/bpm; const whole=quarter*4; return whole*rate; }

    for(let i=0;i<UI.steps.length;i++){
      if(!UI.steps[i].classList.contains('on')) continue;
      const t = i * stepDurSec;

      const chord = UI.chords[i];
      const freqs = Theory.chordToNotes(chord);

      if(arpEnabled){
        const seg = rateToSec(parseRate(arpRate), bpm);
        const count = Math.max(1, Math.floor(stepDurSec/seg));
        const order = (()=>{
          // същата функция като в Transport, но тук само за времеви клипове
          const asc=freqs.slice().sort((a,b)=>a-b);
          const list=[];
          for(let oct=0; oct<arpOct; oct++){
            const mul = Math.pow(2, oct);
            const base = asc.map(f=> f*mul);
            if(arpDir==='Up') list.push(...base);
            else if(arpDir==='Down') list.push(...base.slice().reverse());
            else if(arpDir==='UpDown'){
              const up=base, down=base.slice().reverse().slice(1,-1);
              list.push(...up, ...down);
            }else if(arpDir==='Random'){
              const rnd=base.slice(); for(let i=rnd.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [rnd[i],rnd[j]]=[rnd[j],rnd[i]]; }
              list.push(...rnd);
            }
          }
          return list.length? list : asc;
        })();

        for(let k=0;k<count;k++){
          events.push({ t: t + k*seg, dur: Math.max(0.05, seg*0.9), type:'note' });
        }
      }else if(nrEnabled){
        const seg = rateToSec(parseRate(nrRate), bpm);
        const count = Math.max(1, Math.floor(stepDurSec/seg));
        for(let k=0;k<count;k++){
          events.push({ t: t + k*seg, dur: Math.max(0.06, seg*0.9), type:'note' });
        }
      }else{
        events.push({ t, dur: stepDurSec*0.9, type:'note' });
      }
    }

    Arranger.setEvents(events);
  }

  return { syncChordsToArranger };
})();

/* ======= Wire up buttons ======= */
document.getElementById('startBtn').addEventListener('click', ()=> Transport.start());
document.getElementById('stopBtn').addEventListener('click',  ()=> Transport.stop());
document.getElementById('arrPlay').addEventListener('click', ()=> Arranger.play());
document.getElementById('arrStop').addEventListener('click', ()=> Arranger.stop());

// първоначално попълване на Arranger от текущите настройки
Mirror.syncChordsToArranger();
</script>
</body>
</html>
