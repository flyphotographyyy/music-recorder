<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Stable Music Studio ‚Äî TL+Transport + Bass303 + Wavetable + Recorder</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121926; --panel-2:#0f1623; --text:#e7eef7; --muted:#8aa0b7;
    --accent:#4cc9f0; --red:#ff3b30; --grid:#1c2535;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(160deg,#0b0f14,#0a0d12);color:var(--text);font:14px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{display:flex;align-items:center;gap:12px;padding:14px 16px;background:rgba(255,255,255,.03);backdrop-filter: blur(6px);position:sticky;top:0;z-index:6;border-bottom:1px solid #101624}
  h1{font-size:16px;margin:0;color:var(--text);opacity:.95;font-weight:700}
  .badge{font-size:11px;padding:3px 8px;border-radius:999px;background:linear-gradient(180deg,#122338,#0e1a2b);border:1px solid #1f2a3e;color:var(--muted)}
  main{display:grid;grid-template-columns: 1.15fr .85fr;gap:14px;padding:14px}
  @media (max-width: 980px){ main{grid-template-columns:1fr} }
  .panel{background:var(--panel);border:1px solid #162033;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
  .panel h2{font-size:13px;margin:0;padding:10px 12px;border-bottom:1px solid #17253a;background:linear-gradient(180deg,#121b2a,#0f1827);color:var(--muted);letter-spacing:.4px;text-transform:uppercase}
  .row{display:flex;gap:10px;flex-wrap:wrap;padding:12px}
  .control{display:flex;flex-direction:column;gap:6px;min-width:120px}
  .control label{font-size:12px;color:var(--muted)}
  .btn{appearance:none;border:1px solid #1c2a40;background:linear-gradient(180deg,#152032,#0f1827);color:var(--text);padding:8px 14px;border-radius:10px;cursor:pointer;transition:transform .05s ease,box-shadow .2s}
  .btn:hover{box-shadow:0 4px 16px rgba(76,201,240,.12)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(180deg,#1f2c45,#16243b);border-color:#274260}
  .btn.danger{border-color:#4b1f27;background:linear-gradient(180deg,#3a1217,#2a0f13);color:#ffd7db}
  input, select{background:#0c1320;border:1px solid #1b2942;color:var(--text);padding:8px;border-radius:10px;outline:none}
  select{min-width:120px}
  .kbd{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; background:#0e1726;border:1px solid #1c2a42;border-radius:6px;padding:2px 6px;color:#a9c0db}
  /* step timeline */
  .timeline{padding:12px;display:grid;gap:10px}
  .barLabels{display:flex;justify-content:space-between;font-size:11px;color:#7e91a9;padding:0 4px}
  .steps{display:grid;grid-template-columns: repeat(8, 1fr);gap:8px;position:relative;background:var(--panel-2);padding:10px;border-radius:12px;border:1px solid #1a263b}
  .step{aspect-ratio:1.6/1;border-radius:10px;border:1px solid #23324c;background:linear-gradient(180deg,#0f1827,#0b1320);display:flex;align-items:center;justify-content:center;color:#8aa0b7;cursor:pointer;user-select:none;transition:all .15s}
  .step.on{border-color:#2f8ac9;background:linear-gradient(180deg,#123152,#0e1c32);color:#d8eeff;box-shadow:inset 0 0 0 1px #2f8ac9}
  .playhead{position:absolute;top:8px;bottom:8px;width:3px;background:var(--red);border-radius:2px;box-shadow:0 0 6px rgba(255,59,48,.8);transform:translateX(-1px);pointer-events:none}
  .gridline{position:absolute;top:8px;bottom:8px;width:1px;background:#1e2a3d;opacity:.7}
  .laneTitle{font-size:12px;color:#96a8c0;margin-top:2px}
  .lane{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center}
  .lane .name{color:#9fb3cd;font-size:12px;text-align:right;padding-right:6px}
  .lane .cells{display:grid;grid-template-columns:repeat(8,1fr);gap:8px}
  .cell{aspect-ratio:1.6/1;border-radius:8px;border:1px solid #23324c;background:linear-gradient(180deg,#0f1827,#0b1320);display:flex;align-items:center;justify-content:center;color:#8aa0b7;cursor:pointer}
  .cell.on{border-color:#2f8ac9;background:linear-gradient(180deg,#123152,#0e1c32);color:#d8eeff;box-shadow:inset 0 0 0 1px #2f8ac9}
  .noteRow{display:grid;grid-template-columns:120px repeat(8,1fr);gap:8px}
  .noteRow .name{color:#9fb3cd;text-align:right;padding-right:6px}
  .noteRow select{width:100%}

  /* Arranger (multi-lane) */
  .arranger{padding:12px;border-top:1px solid #17253a;background:linear-gradient(0deg,#0e1624,#0f1a2a)}
  .arr-toolbar{display:flex;gap:10px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .arr-toolbar .len{font-size:12px;color:var(--muted)}
  .arr-wrap{position:relative;border:1px solid #1a263b;border-radius:12px;background:var(--panel-2);height:210px;overflow:hidden}
  .arr-axis{position:absolute;left:0;right:0;top:0;height:18px;color:#7e91a9;font-size:10px;padding:2px 6px;display:flex;gap:12px;align-items:center}
  .arr-track{position:absolute;left:0;right:0;top:18px;bottom:0}
  .arr-event{position:absolute;height:18px;border:1px solid #2a4270;border-radius:6px;background:linear-gradient(180deg,#163055,#102137);color:#cfe6ff;font-size:10px;display:flex;align-items:center;justify-content:center;cursor:grab;user-select:none}
  .arr-event.note{background:linear-gradient(180deg,#1a3a66,#11253d)}
  .arr-event.bass303{background:linear-gradient(180deg,#664a1a,#3d2a11)}
  .arr-event.wt{background:linear-gradient(180deg,#3a1a66,#24113d)}
  .arr-event.drums{background:linear-gradient(180deg,#1a663d,#113d25)}
  .arr-event.pad{background:linear-gradient(180deg,#66401a,#3d2711)}
  .arr-playhead{position:absolute;top:0;bottom:0;width:2px;background:var(--red);box-shadow:0 0 6px rgba(255,59,48,.8);pointer-events:none}
  .arr-limit{position:absolute;top:0;bottom:0;width:6px;background:linear-gradient(180deg,#22314b66,#1a2238cc);border-left:2px dashed #375a86;cursor:ew-resize}
  .laneLabel{position:absolute;left:6px;font-size:10px;color:#97a8c0;opacity:.9}
  .laneGrid{position:absolute;left:0;right:0;height:18px;border-bottom:1px solid #1b2a40}
  .inline-help{font-size:12px;color:#8aa0b7;padding:0 12px 10px}
  .footer{padding:10px 14px;color:#7c8ea6;border-top:1px solid #17253a;font-size:12px;background:linear-gradient(180deg,#101724,#0e1623)}

  /* ==== Mobile/responsive tweaks (no logic / no UI removal) ==== */
  .timeline{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
  #drumGrid{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .steps, #bassCells, #wtCells{ min-width: 560px; }
  #drumGrid{ min-width: 960px; }
  .pads, .pad-tools{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .pads{ min-width: 360px; }
  header{ flex-wrap: wrap; }
  .badge{ margin-top: 4px; }
  .row{ row-gap: 10px; }
  .control{ flex: 1 1 220px; min-width: 160px; }
  @media (max-width: 720px){
    main{ grid-template-columns:1fr; }
    .control{ flex: 1 1 calc(50% - 10px); min-width: calc(50% - 10px); }
    .panel h2{ font-size:12px; padding:8px 10px; }
    .arr-wrap{ height: 180px; }
  }
  @media (max-width: 450px){
    .control{ flex:1 1 100%; min-width:100%; }
    .steps, #bassCells, #wtCells{ min-width: 620px; }
    #drumGrid{ min-width: 1040px; }
    h1{ font-size:14px; }
  }
  .panel{ overflow: hidden; }
  .timeline, #drumGrid, .pads, .pad-tools{ padding-bottom: 6px; }
  input[type="range"], select, button{ touch-action: manipulation; }

  @media (max-width: 980px){
    main{ grid-template-columns:1fr !important; gap:12px !important; }
    header{ flex-wrap:wrap; row-gap:6px; }
    .row{ row-gap:10px; }
    .control{ flex:1 1 46% !important; min-width: 46% !important; }
    .timeline{ overflow-x:visible !important; }
    .steps, .lane .cells, .noteRow{ min-width: auto !important; }
    .steps{ gap:6px !important; padding:8px !important; }
    .step{ aspect-ratio: 1.12/1 !important; }
    .lane .cells{ gap:6px !important; }
    .cell{ aspect-ratio: 1.12/1 !important; }
    .noteRow{ gap:6px !important; }
    #drumGrid{ min-width:auto !important; grid-template-columns: 72px repeat(16, 1fr) !important; }
    #drumGrid > div{ min-width: 0 !important; }
    .pads, .pad-tools{ min-width:auto !important; grid-template-columns: repeat(4, 1fr) !important; }
    .pad{ min-width: 0 !important; }
    .arr-wrap{ height: 180px !important; }
  }
  @media (max-width: 420px){
    .control{ flex: 1 1 100% !important; min-width: 100% !important; }
    .steps{ gap:4px !important; }
    .step{ aspect-ratio: 1.0/1 !important; }
    .lane .cells{ gap:4px !important; }
    .cell{ aspect-ratio: 1.0/1 !important; }
    #drumGrid{ grid-template-columns: 60px repeat(16, 1fr) !important; gap:4px !important; }
  }
  input[type="range"], select, button { touch-action: manipulation; }

  @media (max-width:980px){
    .panel{ overflow: visible !important; }
    .timeline{ overflow: visible !important; }
    body .steps{ display:grid !important; grid-template-columns: repeat(8, minmax(0,1fr)) !important; gap:8px !important; padding:8px !important; min-width:auto !important; }
    body .steps .step{ display:flex !important; align-items:center !important; justify-content:center !important; height:44px !important; min-height:44px !important; aspect-ratio:auto !important; }
    body .lane{ grid-template-columns:72px 1fr !important; }
    body .lane .cells{ display:grid !important; grid-template-columns: repeat(8, minmax(0,1fr)) !important; gap:8px !important; min-width:auto !important; }
    body .lane .cells .cell{ display:flex !important; align-items:center !important; justify-content:center !important; height:44px !important; min-height:44px !important; aspect-ratio:auto !important; }
    body .noteRow{ grid-template-columns:72px repeat(8, minmax(0,1fr)) !important; gap:8px !important; min-width:auto !important; }
    body .noteRow select{ min-width:0 !important; width:100% !important; }
    body #drumGrid{ grid-template-columns:64px repeat(16, minmax(0,1fr)) !important; gap:6px !important; min-width:auto !important; }
    body #drumGrid > div{ min-height:44px !important; }
    body .pads{ grid-template-columns: repeat(4, 1fr) !important; gap:10px !important; }
    body .pads .pad{ display:flex !important; align-items:center !important; justify-content:center !important; height:84px !important; min-height:84px !important; aspect-ratio:auto !important; }
  }
  @media (max-width:420px){
    body .pads{ grid-template-columns: repeat(2, 1fr) !important; }
    body #drumGrid{ grid-template-columns:56px repeat(16, minmax(0,1fr)) !important; gap:4px !important; }
    body .steps .step, body .lane .cells .cell{ height:38px !important; min-height:38px !important; }
  }
</style>
</head>
<body>
<header>
  <h1>Stable Music Studio</h1>
  <span class="badge">Multi-lane Arranger</span>
  <span class="badge">Recorder: WAV / WebM</span>
</header>

<div class="top-tabs" role="navigation" aria-label="Page tabs (mobile)">
  <button data-page="studio" id="tabStudio">Studio</button>
  <button data-page="timeline" id="tabTimeline">Timeline</button>
  <button data-page="arranger" id="tabArranger">Arranger</button>
  <button data-page="drums" id="tabDrums">Drums</button>
</div>

<!-- CSS-only page anchors (hash navigation) -->
<a id="studio" class="anchor-target" aria-hidden="true"></a>
<a id="timeline" class="anchor-target" aria-hidden="true"></a>
<a id="arranger" class="anchor-target" aria-hidden="true"></a>
<a id="drums" class="anchor-target" aria-hidden="true"></a>

<main>
  <section class="panel">
    <h2>Timeline &amp; Transport</h2>

    <div class="row">
      <button id="startBtn" class="btn primary">Start</button>
      <button id="stopBtn" class="btn danger">Stop</button>

      <div class="control">
        <label for="bpm">BPM</label>
        <input type="range" id="bpm" min="60" max="160" step="1" value="120" />
        <div><span id="bpmVal">120</span> bpm</div>
      </div>

      <div class="control">
        <label>Arm TL Rec</label>
        <div class="switch">
          <input type="checkbox" id="armTl" />
          <label for="armTl">Record to Arranger</label>
        </div>
      </div>

      <!-- Recorder controls -->
      <div class="control">
        <label>–ó–∞–ø–∏—Å –∏ –∏–∑—Ç–µ–≥–ª—è–Ω–µ</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="recBtn" class="btn">Rec</button>
          <button id="stopRecBtn" class="btn danger">Stop Rec</button>
          <button id="dlWavBtn" class="btn">Download WAV</button>
          <button id="dlWebmBtn" class="btn" style="display:none">Download WebM</button>
        </div>
        <small id="recStatus" style="color:#8aa0b7">Idle</small>
      </div>
    </div>

    <div class="timeline">
      <div class="barLabels"><span>1</span><span>5</span><span>9</span><span>13</span></div>
      <div class="steps" id="steps">
        <div class="playhead" id="playhead"></div>
        <div class="gridline" style="left:12.5%"></div>
        <div class="gridline" style="left:25%"></div>
        <div class="gridline" style="left:37.5%"></div>
        <div class="gridline" style="left:50%"></div>
        <div class="gridline" style="left:62.5%"></div>
        <div class="gridline" style="left:75%"></div>
        <div class="gridline" style="left:87.5%"></div>
      </div>
      <!-- Chords for main lane -->
      <div class="noteRow" id="chordsRow"><div class="name">Chords</div></div>

      <!-- NEW: Bass 303 lane (steps + note select) -->
      <div class="laneTitle">Bass 303</div>
      <div class="lane">
        <div class="name">Pattern</div>
        <div class="cells" id="bassCells"></div>
      </div>
      <div class="noteRow" id="bassNotesRow"><div class="name">Notes</div></div>

      <!-- NEW: Wavetable lane (steps + note select) -->
      <div class="laneTitle">Wavetable</div>
      <div class="lane">
        <div class="name">Pattern</div>
        <div class="cells" id="wtCells"></div>
      </div>
      <div class="noteRow" id="wtNotesRow"><div class="name">Notes</div></div>
    </div>

    <!-- Instrument parameters -->
    <div class="row">
      <div class="control">
        <label>303 Volume</label>
        <input type="range" id="b303Vol" min="0" max="1" step="0.01" value="0.9" />
      </div>
      <div class="control">
        <label>303 Reso</label>
        <input type="range" id="b303Reso" min="0.1" max="18" step="0.1" value="8" />
      </div>
      <div class="control">
        <label>303 Slide</label>
        <input type="range" id="b303Slide" min="0" max="0.25" step="0.005" value="0.06" />
      </div>
      <div class="control">
        <label>303 Accent</label>
        <input type="range" id="b303Accent" min="0" max="1" step="0.01" value="0.35" />
      </div>
      <div class="control">
        <label>WT Volume</label>
        <input type="range" id="wtVol" min="0" max="1" step="0.01" value="0.8" />
      </div>
      <div class="control">
        <label>WT Morph</label>
        <input type="range" id="wtMorph" min="0" max="1" step="0.01" value="0.4" />
      </div>
      <div class="control">
        <label>WT Hold (s)</label>
        <input type="range" id="wtHold" min="0.05" max="0.7" step="0.01" value="0.25" />
      </div>
    </div>

    <!-- Independent Arranger -->
    <div class="arranger">
      <div class="arr-toolbar">
        <button id="arrPlay" class="btn primary">‚ñ∂ TL Play</button>
        <button id="arrStop" class="btn danger">‚ñ† TL Stop</button>
        <span class="len">Length: <b id="lenLabel">00:30</b> (drag handle)</span>
      </div>
      <div class="arr-wrap" id="arrWrap">
        <div class="arr-axis" id="arrAxis"></div>
        <div class="arr-track" id="arrTrack"></div>
        <div class="arr-playhead" id="arrPlayhead"></div>
        <div class="arr-limit" id="arrLimit" title="Drag to set length"></div>
      </div>
      <div class="inline-help">–î–≤–æ–µ–Ω –∫–ª–∏–∫ –≤—ä—Ä—Ö—É –∫–ª–∏–ø = –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ. –ü–ª—ä–∑–≥–∞–Ω–µ = –º–µ—Å—Ç–µ–Ω–µ. TL Play/Stop —É–ø—Ä–∞–≤–ª—è–≤–∞—Ç –∞—Ä–∞–Ω–∂–µ—Ä–∞. –õ–µ–π–Ω–æ–≤–µ: 1) Chords/Notes, 2) Bass303, 3) Wavetable, 4) Drums, 5) Pads.</div>
    </div>

    <!-- NEW: Save/Reset UI -->
    <div class="row">
      <button class="btn" id="saveSettings">üíæ –ó–∞–ø–∞–∑–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button class="btn danger" id="resetSettings">üóëÔ∏è –ò–∑—á–∏—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <small style="color:#8aa0b7">–ù–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ —Å–µ –∑–∞–ø–∞–∑–≤–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ; –±—É—Ç–æ–Ω–∏—Ç–µ —Å–∞ –∑–∞ —Ä—ä—á–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª.</small>
    </div>

    <div class="footer">–í—Å–∏—á–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∑–∞–ø–∏—Å–≤–∞—Ç –≤ –æ—Ç–¥–µ–ª–Ω–∏ –ª–µ–π–Ω–æ–≤–µ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω <span class="kbd">Arm TL Rec</span>. –ó–∞–ø–∏—Å—ä—Ç —Ä–∞–±–æ—Ç–∏ —Å MediaRecorder (–∞–∫–æ –µ –Ω–∞–ª–∏—á–µ–Ω) –∏–ª–∏ —á—Ä–µ–∑ –≤—ä—Ç—Ä–µ—à–µ–Ω WAV –∑–∞–ø–∏—Å–≤–∞—á.</div>
  </section>

  <section class="panel">
    <h2>Drum Machine &amp; MPC</h2>
    <div class="row">
      <div class="control">
        <label>Master Volume</label>
        <input type="range" id="masterVol" min="0" max="1" step="0.01" value="0.8" />
      </div>
      <div class="control">
        <label>Chorus Amount</label>
        <input type="range" id="chorusMix" min="0" max="0.8" step="0.01" value="0.25" />
      </div>
      <div class="control">
        <label>Cutoff</label>
        <input type="range" id="cutoff" min="200" max="8000" step="1" value="2200" />
      </div>
      <div class="control">
        <label>Resonance (Q)</label>
        <input type="range" id="reso" min="0.1" max="18" step="0.1" value="0.5" />
      </div>
    </div>
    <div class="row">
      <div class="control"><label>Kick/Snare/Hat/Clap</label><small style="color:#8aa0b7">16-step —Ä–µ—à–µ—Ç–∫–∞</small></div>
    </div>
    <div class="drum-grid" id="drumGrid" style="display:grid;grid-template-columns: 100px repeat(16, 1fr);gap:6px;padding:8px;background:var(--panel-2);border-radius:12px;border:1px solid #1a263b"></div>

    <h2>MPC Sampler Pads</h2>
    <div class="pads" id="mpcPads" style="display:grid;grid-template-columns: repeat(4, 1fr);gap:10px;padding:10px"></div>
    <div class="pad-tools" id="padTools" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:0 10px 10px"></div>
    <div class="footer">Pads –∏ Drums —Å—ä—â–æ –∑–∞–ø–∏—Å–≤–∞—Ç –≤ –ª–µ–π–Ω–æ–≤–µ—Ç–µ —Å–∏ –ø—Ä–∏ Arm TL Rec.</div>
  </section>
</main>

<script>
/* ================== Audio Core ================== */
const Audio = (()=>{
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const master = ctx.createGain(); master.gain.value=0.8; master.connect(ctx.destination);
  const tapBus = ctx.createGain(); tapBus.gain.value = 1.0; master.connect(tapBus); // for recorder
  const dryBus = ctx.createGain(); dryBus.gain.value=0.75; dryBus.connect(master);
  const chorusBus = ctx.createGain(); chorusBus.gain.value=0.25;
  const chorusDelay = ctx.createDelay(0.05);
  const lfo = ctx.createOscillator(); const lfoGain=ctx.createGain(); lfoGain.gain.value=0.004; lfo.frequency.value=0.8; lfo.connect(lfoGain).connect(chorusDelay.delayTime);
  chorusBus.connect(chorusDelay).connect(master); lfo.start();
  const params = { cutoff:2200, reso:.5 };
  function setMasterVol(v){ master.gain.value=v; }
  function setChorusMix(v){ chorusBus.gain.value=v; }
  function setFilterCutoff(v){ params.cutoff=v; }
  function setFilterQ(v){ params.q=v; params.reso=v; }

  function playVoice({freq=220,time=ctx.currentTime,dur=0.25,vel=0.9}){
    const osc = ctx.createOscillator(); osc.type="sawtooth"; osc.frequency.setValueAtTime(freq,time);
    const filt = ctx.createBiquadFilter(); filt.type="lowpass"; filt.frequency.setValueAtTime(params.cutoff,time); filt.Q.setValueAtTime(params.reso??0.5,time);
    const env = ctx.createGain(); env.gain.setValueAtTime(0.0001,time);
    const A=0.005,D=Math.min(.4,dur*.6),S=0.25,R=0.12;
    env.gain.linearRampToValueAtTime(vel,time+A);
    env.gain.linearRampToValueAtTime(vel*S,time+A+D);
    env.gain.linearRampToValueAtTime(0.0001,time+dur+R);
    const dryTap=ctx.createGain(); const chTap=ctx.createGain(); dryTap.gain.value=1; chTap.gain.value=1;
    osc.connect(filt).connect(env); env.connect(dryTap).connect(dryBus); env.connect(chTap).connect(chorusBus);
    osc.start(time); osc.stop(time+dur+0.2);
    osc.onended=()=>{try{osc.disconnect();filt.disconnect();env.disconnect();dryTap.disconnect();chTap.disconnect();}catch{}}
  }

  /* Drums */
  function kick(time=ctx.currentTime, vel=1.0){
    const osc=ctx.createOscillator(), env=ctx.createGain();
    osc.type="sine"; osc.frequency.setValueAtTime(140,time); osc.frequency.exponentialRampToValueAtTime(40,time+0.12);
    env.gain.setValueAtTime(0.0001,time); env.gain.exponentialRampToValueAtTime(vel,time+0.002); env.gain.exponentialRampToValueAtTime(0.0001,time+0.25);
    osc.connect(env).connect(dryBus); osc.start(time); osc.stop(time+0.26);
    osc.onended=()=>{try{osc.disconnect();env.disconnect();}catch{}}
  }
  function snare(time=ctx.currentTime, vel=0.8){
    const size=2*ctx.sampleRate, buf=ctx.createBuffer(1,size,ctx.sampleRate), data=buf.getChannelData(0);
    for(let i=0;i<size;i++) data[i]=Math.random()*2-1;
    const src=ctx.createBufferSource(); src.buffer=buf; const bp=ctx.createBiquadFilter(); bp.type="bandpass"; bp.frequency.value=1800; bp.Q.value=0.6;
    const env=ctx.createGain(); env.gain.setValueAtTime(0.0001,time); env.gain.exponentialRampToValueAtTime(vel,time+0.002); env.gain.exponentialRampToValueAtTime(0.0001,time+0.18);
    src.connect(bp).connect(env).connect(dryBus); src.start(time); src.stop(time+0.2);
    src.onended=()=>{try{src.disconnect();bp.disconnect();env.disconnect();}catch{}}
  }
  function hat(time=ctx.currentTime, vel=0.6){
    const size=1*ctx.sampleRate, buf=ctx.createBuffer(1,size,ctx.sampleRate), data=buf.getChannelData(0);
    for(let i=0;i<size;i++) data[i]=(Math.random()*2-1)*0.7;
    const src=ctx.createBufferSource(); src.buffer=buf; const hp=ctx.createBiquadFilter(); hp.type="highpass"; hp.frequency.value=7000;
    const env=ctx.createGain(); env.gain.setValueAtTime(0.0001,time); env.gain.exponentialRampToValueAtTime(vel,time+0.001); env.gain.exponentialRampToValueAtTime(0.0001,time+0.06);
    src.connect(hp).connect(env).connect(dryBus); src.start(time); src.stop(time+0.08);
    src.onended=()=>{try{src.disconnect();hp.disconnect();env.disconnect();}catch{}}
  }
  function clap(time=ctx.currentTime, vel=0.65){ for(let i=0;i<3;i++){ snare(time+i*0.01, vel*0.55); } }

  /* Sampler (pads) */
  function createSampler(){
    const slots = new Array(16).fill(null);
    async
